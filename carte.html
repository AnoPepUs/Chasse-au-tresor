<!-- Leaflet JS & Geocoder (inchangÃ©s) -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>

<script>
/* ===== CONFIGURATION ===== */
const ZOOM_MIN_POUR_TRESORS = 15;

const tresors = [
  { lat: 27.988056, lng: 86.925278, icon: 'ğŸ‘‘', titre: 'Le Toit du Monde', description: 'ğŸ”ï¸ Mont Everest - 8,849m<br><i>"Bitcoin c\'est le roi, tu le trouveras sur le toit"</i>', video: 'https://www.youtube.com/watch?v=VOTRE_VIDEO_EVEREST' },
  { lat: 25.112222, lng: 55.138889, icon: 'ğŸŒ´', titre: 'Les Palmiers Artificiels', description: 'ğŸï¸ Palm Jumeirah - DubaÃ¯<br><i>Un archipel en forme de palmier visible de l\'espace</i>', video: 'https://www.youtube.com/watch?v=VOTRE_VIDEO_DUBAI' },
  { lat: -14.739444, lng: -75.133333, icon: 'ğŸµ', titre: 'Le Singe de Nazca', description: 'ğŸ—¿ Lignes de Nazca - PÃ©rou<br><i>GÃ©oglyphe mystÃ©rieux de 2000 ans</i>', video: 'https://www.youtube.com/watch?v=VOTRE_VIDEO_NAZCA' },
  { lat: 32.133333, lng: -110.95, icon: 'âœˆï¸', titre: 'L\'Avion du DÃ©sert', description: 'ğŸœï¸ CimetiÃ¨re d\'avions - Arizona<br><i>Des milliers d\'avions abandonnÃ©s dans le dÃ©sert</i>', video: 'https://www.youtube.com/watch?v=VOTRE_VIDEO_AVION' }
];

/* ===== CARTE ===== */
const map = L.map('map', { center: [20, 0], zoom: 3, zoomControl: true, attributionControl: true });
map.getContainer().setAttribute('role', 'region');
map.getContainer().setAttribute('aria-label', 'Carte des trÃ©sors');

/* ===== COUCHES ===== */
const esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Â© Esri, DigitalGlobe, GeoEye',
  maxZoom: 19
});

const osmLabels = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors',
  maxZoom: 19,
  opacity: 0.6
});

const osmFull = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors',
  maxZoom: 19
});

const satelliteAvecLabels = L.layerGroup([esriSatellite, osmLabels]);

/* couche par dÃ©faut */
satelliteAvecLabels.addTo(map);

/* contrÃ´le des couches */
const baseMaps = {
  "ğŸ›°ï¸ Satellite + Labels": satelliteAvecLabels,
  "ğŸ›°ï¸ Satellite seul": esriSatellite,
  "ğŸ—ºï¸ Carte OpenStreetMap": osmFull
};
L.control.layers(baseMaps).addTo(map);

/* ===== TOGGLE LABELS (contrÃ´le dÃ©diÃ©) ===== */
const toggleLabels = document.getElementById('toggle-labels');
if (toggleLabels) {
  toggleLabels.addEventListener('change', function() {
    if (this.checked) {
      if (!map.hasLayer(osmLabels)) map.addLayer(osmLabels);
      if (!map.hasLayer(esriSatellite)) map.addLayer(esriSatellite);
    } else {
      if (map.hasLayer(osmLabels)) map.removeLayer(osmLabels);
      if (!map.hasLayer(esriSatellite)) map.addLayer(esriSatellite);
    }
  });
}

/* ===== GEOCODER ===== */
L.Control.geocoder({ defaultMarkGeocode: false, placeholder: 'Rechercher un lieu...', errorMessage: 'Aucun rÃ©sultat' })
  .on('markgeocode', function(e) {
    if (e.geocode && e.geocode.bbox) {
      map.fitBounds(e.geocode.bbox);
    }
  })
  .addTo(map);

/* ===== MARQUEURS ===== */
let markers = [];

function createTreasureIcon(emoji) {
  return L.divIcon({
    html: `<div class="treasure-marker" style="font-size: 40px; text-align: center;">${emoji}</div>`,
    className: '',
    iconSize: [50, 50],
    iconAnchor: [25, 50],
    popupAnchor: [0, -50]
  });
}

function createPopupContent(tresor) {
  // Si les descriptions sont dynamiques, appliquer une sanitation cÃ´tÃ© serveur ou ici.
  return `
    <div class="popup-title">${tresor.icon} ${tresor.titre}</div>
    <div class="popup-description">${tresor.description}</div>
    <a href="${tresor.video}" target="_blank" rel="noopener noreferrer" class="popup-link">ğŸ¬ Voir la vidÃ©o</a>
  `;
}

tresors.forEach(t => {
  const m = L.marker([t.lat, t.lng], { icon: createTreasureIcon(t.icon), opacity: 0 });
  m.bindPopup(createPopupContent(t));
  markers.push({ marker: m, tresor: t });
});

/* ===== AFFICHAGE SELON ZOOM ===== */
function updateMarkers() {
  const currentZoom = map.getZoom();
  const zoomEl = document.getElementById('zoom-current');
  if (zoomEl) zoomEl.textContent = currentZoom;

  markers.forEach(({ marker }) => {
    if (currentZoom >= ZOOM_MIN_POUR_TRESORS) {
      if (!map.hasLayer(marker)) {
        marker.addTo(map);
        // animation CSS prÃ©fÃ©rable, fallback JS:
        marker.setOpacity(0);
        setTimeout(() => marker.setOpacity(1), 120);
      }
    } else {
      if (map.hasLayer(marker)) map.removeLayer(marker);
    }
  });
}

map.on('zoomend', updateMarkers);
updateMarkers();

console.log('âœ… Carte initialisÃ©e â€” trÃ©sors:', tresors.length);
</script>
