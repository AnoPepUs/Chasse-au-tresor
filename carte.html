<script>
const apiKey = "oqClb1tzK5aOivVVpyvd";

// Carte
const map = L.map('map', {
  minZoom: 2,
  maxZoom: 20
}).setView([20, 0], 2);

// Satellite
L.tileLayer(
  `https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=${apiKey}`,
  {
    maxZoom: 20,
    attribution: '© MapTiler © OpenStreetMap'
  }
).addTo(map);

// Labels
L.tileLayer(
  `https://api.maptiler.com/maps/hybrid/256/{z}/{x}/{y}.png?key=${apiKey}`,
  {
    maxZoom: 20,
    opacity: 1
  }
).addTo(map);

// Barre de recherche
L.Control.geocoder().addTo(map);

// Charger GeoJSON
fetch("https://anopepus.github.io/Chasse-au-tresor/data/cryptos.geojson")
  .then(r => r.json())
  .then(data => {

    L.geoJSON(data, {

      style: {
        color: "#00ffaa",
        weight: 2,
        fillColor: "#00ffcc",
        fillOpacity: 0.15
      },

      onEachFeature: (feature, layer) => {
        const p = feature.properties;

        const popup = `
          <h3>${p.name}</h3>
          <img class="popup-img" src="${p.image}" />
          <br><br>
          <a href="${p.video}" target="_blank">Voir la vidéo</a>
        `;

        // Popup seulement si on est assez zoomé
        layer.on("click", () => {
          if (map.getZoom() >= 12) {
            layer.bindPopup(popup).openPopup();
          } else {
            alert("Zoom encore un peu pour découvrir le trésor !");
          }
        });
      }

    }).addTo(map);

  });
</script>
