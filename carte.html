<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <link rel="shortcut icon" href="favicon.png" type="image/png">
  <title>Chasse au Tr√©sor Crypto</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Geocoder -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    body { margin: 0; padding: 0; }
    #map { width: 100vw; height: 100vh; }
    #coords {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 9999;
    }
    .popup-img {
      width: 200px;
      border-radius: 8px;
    }
    .measure-btn {
      background: white;
      border: 2px solid #666;
      border-radius: 4px;
      width: 32px;
      height: 32px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
    }
    .measure-btn.active {
      background: #007bff;
      color: white;
      border-color: #0056b3;
    }
  </style>
</head>

<body>
<!-- Barre de navigation --> 
  <nav> 
    <a href="index.html" target="_blank">Accueil</a> 
    <a href="carte.html" target="_blank">Carte</a> 
    <a href="enigmes.html" target="_blank">√ânigmes</a> 
  </nav>
  
<div id="map"></div>
<div id="coords">Lat: -- | Lng: --</div>

<script>
const apiKey = "oqClb1tzK5aOivVVpyvd";

// Carte
const map = L.map('map', {
  minZoom: 2,
  maxZoom: 20
}).setView([20, 0], 2);

// Satellite
L.tileLayer(
  `https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=${apiKey}`,
  { maxZoom: 20, attribution: '¬© MapTiler ¬© OpenStreetMap' }
).addTo(map);

// Labels
L.tileLayer(
  `https://api.maptiler.com/maps/hybrid/256/{z}/{x}/{y}.png?key=${apiKey}`,
  { maxZoom: 20, opacity: 1 }
).addTo(map);

// Barre de recherche
L.Control.geocoder().addTo(map);

// Affichage des coordonn√©es GPS
map.on("mousemove", (e) => {
  document.getElementById("coords").innerHTML =
    `Lat: ${e.latlng.lat.toFixed(6)} | Lng: ${e.latlng.lng.toFixed(6)}`;
});


// --- BOUTON R√àGLE ---
let measureActive = false;
let startPoint = null;
let tempLine = null;
let tempMarkerA = null;
let tempMarkerB = null;

const MeasureControl = L.Control.extend({
  onAdd: function() {
    const btn = L.DomUtil.create("div", "measure-btn");
    btn.innerHTML = "üìè";

    btn.onclick = () => {
      measureActive = !measureActive;
      btn.classList.toggle("active");

      if (!measureActive) {
        startPoint = null;
        if (tempLine) map.removeLayer(tempLine);
        if (tempMarkerA) map.removeLayer(tempMarkerA);
        if (tempMarkerB) map.removeLayer(tempMarkerB);
      }
    };

    L.DomEvent.disableClickPropagation(btn);
    return btn;
  }
});

new MeasureControl({ position: "topleft" }).addTo(map);


// --- LOGIQUE DE MESURE ---
map.on("click", (e) => {
  if (!measureActive) return;

  if (!startPoint) {
    startPoint = e.latlng;

    if (tempMarkerA) map.removeLayer(tempMarkerA);
    if (tempMarkerB) map.removeLayer(tempMarkerB);
    if (tempLine) map.removeLayer(tempLine);

    tempMarkerA = L.marker(startPoint, { opacity: 0.7 }).addTo(map);

  } else {
    const endPoint = e.latlng;

    if (tempMarkerB) map.removeLayer(tempMarkerB);
    tempMarkerB = L.marker(endPoint, { opacity: 0.7 }).addTo(map);

    if (tempLine) map.removeLayer(tempLine);
    tempLine = L.polyline([startPoint, endPoint], {
      color: "#00aaff",
      weight: 3
    }).addTo(map);

    const d = map.distance(startPoint, endPoint);
    const txt = d > 1000
      ? (d / 1000).toFixed(2) + " km"
      : Math.round(d) + " m";

    tempLine.bindPopup("Distance : " + txt).openPopup();

    startPoint = null;
  }
});


// Charger GeoJSON
fetch("https://anopepus.github.io/Chasse-au-tresor/data/cryptos.geojson")
  .then(r => r.json())
  .then(data => {

    L.geoJSON(data, {

      // Plus de polygones ‚Üí Points uniquement
      pointToLayer: (feature, latlng) => {
        const p = feature.properties;

        const icon = L.icon({
          iconUrl: p.icon,
          iconSize: [48, 48],
          iconAnchor: [24, 24],
          popupAnchor: [0, -24]
        });

        const marker = L.marker(latlng, { icon });

        // Ic√¥ne visible seulement si zoom >= 10
        map.on("zoomend", () => {
          if (map.getZoom() >= 10) {
            if (!map.hasLayer(marker)) map.addLayer(marker);
          } else {
            if (map.hasLayer(marker)) map.removeLayer(marker);
          }
        });

        // Clic sur le diamant
        marker.on("click", () => {
          const distance = map.distance(map.getCenter(), latlng);

          if (distance <= 500) {
            marker.bindPopup(`
              <h3>${p.name}</h3>
              <img class="popup-img" src="${p.image}" />
              <br><br>
              <a href="${p.video}" target="_blank">Voir la vid√©o</a>
            `).openPopup();
          } else {
            alert("Tu es trop loin du tr√©sor, rapproche-toi !");
          }
        });

        return marker;
      }

    });

  });
</script>

</body>
</html>
